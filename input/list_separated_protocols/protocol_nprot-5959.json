[
    {
        "title": "**Chip inspection**",
        "body": [
            "The micro-patterned chips are manufactured from single-crystalline silicon and consist of an outer frame structure and an inner membrane part \\(Fig.",
            {
                "title": "1).",
                "body": "<a href=\"#figures\" data-url=\"http://www.nature.com/protocolexchange/system/uploads/5613/thumbnail/Figure1.png?1494274773\">See figure in Figures section.</a>\r\n\n\nThe inner membrane has a thickness of less than 10 μm and is equipped with a regular array of micropores. Before mounting a chip on the goniometer, the integrity of the silicon membrane should be checked and that the chip is properly attached to its holder. Broken silicon debris or other not correctly oriented silicon material can cause strong silicon Bragg reflections if hit by the X-ray beam and thereby can potentially damage the detector.  \r\n\n\nIf it is required to rotate the chip during the measurements \\(to avoid incomplete data due to preferred orientation of the crystals on the chip) it is further recommended to carefully check for correct orientation of the chips on the goniometer.  This is ideally done by slowly rotating a chip during a few line scans while exposing it to highly attenuated \\(transmission < 10<sup>-6</sup>) X-ray pulses and collecting diffraction images."
            }
        ]
    },
    {
        "title": "**Chip loading**",
        "body": [
            "For sample loading onto the chips a drop of typically 1 – 3 μl microcrystal suspension is pipetted onto the top-side of the membrane area. Subsequently, the mother liquor is soaked through the pores by touching the bottom side of the chip with a wedge of filter paper \\(Fig.",
            {
                "title": "2).",
                "body": "<a href=\"#figures\" data-url=\"http://www.nature.com/protocolexchange/system/uploads/5615/thumbnail/Figure2.png?1494274841\">See figure in Figures section.</a>\r\n\n\nIn this way the mother liquor is wicked away efficiently and all crystals larger than the pore size are retained on the upper side of the chip membrane and arrange themselves according to the pore pattern. To prevent dehydration, the crystals are constantly maintained in a stream of humidified gas<sup>11</sup>. For room-temperature data collection sample loading is performed with the chip already mounted on the goniometer \\(Procedure A). For cryogenic data collection sample loading is performed in a similar way but can be performed offline in a laboratory \\(Procedure B). After sample loading the chips are immediately flash-frozen by plunging them into liquid nitrogen. For data collection chips are mounted onto the goniometer while maintaining cryogenic temperatures. For cryogenic chip handling standard tools for cryo-crystallography can be used."
            }
        ]
    },
    {
        "title": "**Procedure A: Chip loading for room-temperature data collection**",
        "body": []
    },
    {
        "title": "**1**",
        "body": "Start the Roadrunner software on the control computer."
    },
    {
        "title": "**2**",
        "body": "Press the button “Set mount position”. This moves the goniometer stages to a pre-configured mounting position where the sample can be mounted without damaging the goniometer."
    },
    {
        "title": "**3**",
        "body": "Mount the chip on the Roadrunner goniometer."
    },
    {
        "title": "**4**",
        "body": "Press the button “Set sample in position”. The sample is then moved into the field of view of the inline sample viewing microscope."
    },
    {
        "title": "**5**",
        "body": "Make sure that the humidified gas stream is turned on and well centered on the chip. Adjust the relative humidity of the gas stream using the dewpoint generator to the appropriate value. It should be matched to the concentration of precipitant and cryoprotectant of the mother liquor \\(see Ref. 12 for details). The equilibrium relative humidity can be determined in advance by monitoring a drop of mother liquor within the humidity stream. When equilibrium relative humidity is reached, the size of the drop remains constant."
    },
    {
        "title": "**6**",
        "body": "Churn the suspension of crystals in order to obtain a uniform concentration of crystals within your mother liquor. Then apply a drop of 2 – 3 µl of crystal suspension onto the top of the membrane part of the chip \\(Figure 2A). Avoid touching the chip with the tip of the micropipette, as the membrane is very fragile. The drop should be contained within the well on the top side of the chip."
    },
    {
        "title": "**7**",
        "body": "Attach a wedge of filter paper to the bottom side of the chip so that the filter paper is oriented parallel to the chip \\(Figure 2B). Once the filter paper is in contact with the micropores, the mother liquor is soaked through the pores \\(Figure 2C) and crystals larger than the pore size are retained on the upper side of the chip \\(Figure 2D). Also see Ref. 9 for details."
    },
    {
        "title": "**8**",
        "body": [
            "If possible inspect the distribution of crystals on the top side of the chip with an optical microscope. A typical distribution of crystals is shown in Figure",
            {
                "title": "3.",
                "body": "<a href=\"#figures\" data-url=\"http://www.nature.com/protocolexchange/system/uploads/5617/thumbnail/Figure3_with_scale.png?1494274908\">See figure in Figures section.</a>\r\n\n\nIf the concentration of crystals is too low, repeat steps 4 and 5 with the very same chip. If the concentration of crystals is too high, dilute the suspension with an extra amount of mother liquor and proceed with a new chip."
            }
        ]
    },
    {
        "title": "**9**",
        "body": "Rotate the chip by 90 degrees so that the flat side of the chip faces the X-ray beam and the crystals are on the other side in direction of the detector."
    },
    {
        "title": "**Procedure B: Chip loading for cryogenic data collection**",
        "body": []
    },
    {
        "title": "**1**",
        "body": "Perform offline sample loading in the lab similar to the procedure as described in steps 5 – 9 in the previous procedure \\(Procedure A ‘Chip loading for room temperature data collection’)."
    },
    {
        "title": "**2**",
        "body": [
            "After removal of the mother liquor \\(step",
            {
                "title": "7)",
                "body": "and, ideally, optical inspection with a microscope \\(step"
            },
            {
                "title": "8)",
                "body": "directly dip the chip loaded with the crystals into liquid nitrogen for flash-freezing. Make sure to act fast in order to prevent the crystals from drying out."
            }
        ]
    },
    {
        "title": "**3**",
        "body": "Enclose the chip carefully with a vial while it is kept in liquid nitrogen. Transport the vial to the beamline, keeping it in liquid nitrogen all the time."
    },
    {
        "title": "**4**",
        "body": "Make sure that the open-flow cryostat is installed and aligned properly."
    },
    {
        "title": "**5**",
        "body": "Wet mount the chip on the goniometer: Put the magnetic mount of the chip onto the goniometer and quickly remove the vial parallel to the chip. Take care that the chip is not damaged while the vial is removed."
    },
    {
        "title": "**6**",
        "body": "Rotate the chip so that the flat side faces the X-ray beam."
    },
    {
        "title": "**Using the Roadrunner software for data collection**",
        "body": "The main elements of the Roadrunner goniometer are high-precision piezo-scanning stages, which are operated in closed loop and allow for fast translation of the chip with a speed of up to 2.5 mm/s. The piezo motors are controlled by a DMC-4080 motion controller from Galil, which is capable of synchronized motion with respect to the LCLS pulse train at 120 Hz. For data collection the membrane of the chip is scanned line by line in a 2D meander scan. For chip alignment, the Roadrunner goniometer provides a rotational stage with a vertical rotation axis and a translation stage for movement in beam direction. The rotational stage is used during pre-alignment to ensure that no silicon Bragg reflections, which could possibly harm the detector, are excited. Additionally, through rotation of the chip during data collection it is possible to avoid preferred orientations of the crystals on the chip and therefore to cover a larger part of reciprocal space. The linear translation stage is used to move the chip in the center of rotation."
    },
    {
        "title": "**1**",
        "body": "By pressing the button “Autofocus gonio Z” the chip surface is automatically moved into the focal plane of the inline sample viewing microscope and a sharp image of the chip surface should appear on the screen."
    },
    {
        "title": "**2**",
        "body": "Now click on the “Clear raster” button to prepare for a new alignment grid."
    },
    {
        "title": "**3**",
        "body": "Use the arrow buttons located on the top right part of the GUI to move the chip so that the upper left corner of the membrane of the chip appears on the microscope image."
    },
    {
        "title": "**4**",
        "body": "Click on the “Set top left corner” button. Move the mouse pointer to the upper left micro-pore of the membrane area of the chip in the microscope image. A click with the left mouse button now defines the upper left corner of the scanning grid."
    },
    {
        "title": "**5**",
        "body": "Use the arrow buttons again to move to the upper right corner. Now click the button named “Set top right corner” and click on the most right pore in the same row as the upper left micro-pore. Now the first upper line of the scan grid is defined. Now two guide lines are indicated on the microscope image. One straight line \\(in more or less) horizontal direction represents the first upper scan line which is overlaid to first row of micro-pores on the chip. The second line is oriented perpendicular to the first line and is meant to assist in defining the lower left micro-pore of the chip."
    },
    {
        "title": "**6**",
        "body": "Use the arrow buttons to move to the lower left corner of the chip. Now click the button named “Set bottom left corner” and click on the position where the lowest left micropore of the chip intersects with the guide line. After this the scanning grid is defined and indicated as a green mesh on the microscope image. If the grid does not exactly coincide with pore positions it can be manually adjusted by using the right mouse button to drag and drop the grid in the microscope image. If necessary, the whole procedure can be repeated by starting again with point 2."
    },
    {
        "title": "**7**",
        "body": "Enter the sample name in the field “Scan name”."
    },
    {
        "title": "**8**",
        "body": "In order to achieve better coverage of reciprocal space during a scan, the chip can be automatically rotated in small increments during the scan. To do so, the starting and stopping angles of the goniometer have to be entered in the corresponding fields."
    },
    {
        "title": "**9**",
        "body": "In case that only part of the chip is covered with microcrystals, it is possible to enter the number of the first and the last row to be scanned. Otherwise, the entire scanning grid will be scanned."
    },
    {
        "title": "**10**",
        "body": "Enter the current X-ray pulse arrival frequency in the “Scan frequency” field. This frequency depends on the operation mode of the XFEL and/or potential settings of the pulse picker."
    },
    {
        "title": "**11**",
        "body": "Define the number of acceleration pulses which are used to achieve a constant speed of the chip and to synchronize the position of the micropores to the arrival of the X-ray pulses. A typically used value is 30."
    },
    {
        "title": "**12**",
        "body": "Now the scan can be started by pressing the “Start Scan” button. The progress of the scan is indicated with a progress bar located on the bottom part of the GUI."
    },
    {
        "title": "**13**",
        "body": "After the scan is finished, press the button “Set mount position” to drive the chip into a save position where it can be removed from the goniometer."
    },
    {
        "title": "**14**",
        "body": "Remove the chip from the goniometer."
    },
    {
        "title": "**Data processing**",
        "body": "LCLS detector images are stored in a sequential data format called XTC, which is beneficial in terms of fast data storage and reliability. For data analysis and processing, XTC data streams are converted into more convenient formats such as pickle or HDF5. The converted images can then be loaded into common programs for SFX data processing such as _CrystFEL_<sup>13</sup> and _cppxfel_<sup>14</sup>. In the following, conversion of XTC streams into individual pickle files is described by using the _cctbx.xfel_ software suite, resulting in one pickle file per image. The hitfinder in the _cctbx.xfel_ routine allows for filtering of the recorded detector images according to the number of possible diffraction peaks present on the image. In this way, blank images are sorted out and only possible crystal hits are used for further data processing. Diffraction images considered as hits are then passed into the processing pipeline of _cppxfel_, which includes indexing, integration, initial orientation matrix refinement and post refinement. The workflow and the underlying principles of cppxfel are discussed in Ref. 14."
    },
    {
        "title": "**1**",
        "body": "Use a unix shell to log onto the SLAC computing environment, using your SLAC unix account username and password: \r\n\n\n_ssh -X <username>@pslogin.slac.stanford.edu_"
    },
    {
        "title": "**2**",
        "body": "Log onto the psana machine used for XTC conversion: \r\n\n\n_ssh -X psana_"
    },
    {
        "title": "**3**",
        "body": "Setup your psana python environment by using one of the following commands.\r\n\n\nFor c-shell: \r\n\n\n_source /reg/g/psdm/etc/ana_env.csh_\r\n\n\nFor bash shell: \r\n\n\n_source /reg/g/psdm/etc/ana_env.sh_\r\n\n\nFor further explanation see \"here\":https://confluence.slac.stanford.edu/display/PSDM/psana+python+Setup.\r\n\n\nAdditional information can also be found \"here\":http://viper.lbl.gov/cctbx.xfel/index.php/Set_up_PSDM_software."
    },
    {
        "title": "**4**",
        "body": "Setup cctbx.xfel as described \"here\":http://viper.lbl.gov/cctbx.xfel/index.php/Setup."
    },
    {
        "title": "**5**",
        "body": "Follow the preparatory steps for image conversion as described \"here\":http://viper.lbl.gov/cctbx.xfel/index.php/Preparatory_steps#Creating_a_mask_image. These steps involve dark subtraction in order to account for temperature distortions in the detector and the creation of a mask image in order to mask of any bad pixels. Averaged light images might also be useful to flag up obvious errors in detector metrology. Misaligned quadrants of the detector will be recognized as non-continuous rings in the virtual powder patterns. In case the panel coordinates need to be redefined, see \"here\":http://viper.lbl.gov/cctbx.xfel/index.php/Metrology_refinement. For further details regarding metrology refinement or contact your local support."
    },
    {
        "title": "**6**",
        "body": "Submit a processing job to the cluster which will convert your image data to individual pickle files as described \"here\":http://viper.lbl.gov/cctbx.xfel/index.php/Indexing_and_integration. You need to edit a configuration file \\(*.cfg) file which will contain the necessary image paths and input settings for dark run subtraction, bad pixel masking and hit-finding. Do not use the indexing and integration option of _cctbx.xfel_ as these steps will be later performed using cppxfel."
    },
    {
        "title": "**7**",
        "body": "Transfer the images to your local machine. For installation of _cppxfel_ on your local machine follow the instructions as described \"here\":http://viper.lbl.gov/cctbx.xfel/index.php/Cppxfel_Installation. The installation relies on three components: the DIALS distribution, which will provide certain _cctbx_ libraries for L-BFGS refinement, the _cppxfel_ distribution and boost libraries, which allow for multicore threading."
    },
    {
        "title": "**8**",
        "body": "Follow the instructions for indexing using the _TakeTwo_ algorithm of _cppxfel_ as described \"here\":http://viper.lbl.gov/cctbx.xfel/index.php/Cppxfel_Indexing. Prior to starting the indexing algorithm the DIALS<sup>16</sup> spotfinder is used for localization of strong spots within your diffraction images. Strong spots coordinates of each image are then output to individual text files used by _cppxfel_ for finding one or multiple indexing solutions. In case your diffraction data contains diffraction patterns from multiple crystals on one image ensure that the parameter “SOLUTION_ATTEMPTS” in the parameter input file is followed by a number larger than one. An exemplary parameter input file used for indexing of SFX data is given in List 1."
    },
    {
        "title": "**9**",
        "body": "Start initial orientation matrix refinement in order to produce a set of orientation matrices for each individual found indexing solutions \\(see \"here\":http://viper.lbl.gov/cctbx.xfel/index.php/Cppxfel_Initial_Orientation_Matrix_Refinement).\r\n\n\nAn exemplary parameter input file used for initial orientation matrix refinement is given in List 2."
    },
    {
        "title": "**10**",
        "body": "Perform post-refinement of the integrated intensities, ideally against an external reference data set if available from a previous run, or from scratch if the first time \\(see \"here\":http://viper.lbl.gov/cctbx.xfel/index.php/Cppxfel_Post-refinement). The algorithm will also break possible indexing ambiguities as discussed by Brehm & Diederichs<sup>15</sup>. Note that at the moment only two-fold indexing ambiguities can be broken without providing an external reference MTZ file. An exemplary parameter input file used for post refinement is given in List 3."
    },
    {
        "title": "**11**",
        "body": "A final reflection MTZ file will be produced automatically during post-refinement. To assess common crystallographic statistical parameters such as CC<sub>1/2</sub>, R<sub>split</sub>, R<sub>merge</sub>, R<sub>meas</sub> or R<sub>pim</sub>, see \"here\":http://viper.lbl.gov/cctbx.xfel/index.php/Cppxfel_Statistics."
    },
    {
        "title": "**Phase extension**",
        "body": "Density modification, cyclic averaging and phase extension were performed as described by Gouet et al.<sup>17</sup>"
    },
    {
        "title": "**1**",
        "body": "Fourier transform the reflection list with starting amplitude/phase information to a given resolution to produce a starting map."
    },
    {
        "title": "**2**",
        "body": [
            "Density modification preparation: Calculate envelope using GAP \\(version for download published in Ref.",
            {
                "title": "18)",
                "body": "for appropriate virus, space group and unit cell dimensions based on starting map. Repeat calculation every 10th cycle."
            }
        ]
    },
    {
        "title": "**3**",
        "body": "Density modification and cyclic averaging: Use envelope and NCS parameters to cyclically average the current electron density map using GAP in space group P1."
    },
    {
        "title": "**4**",
        "body": "Use _ccp4_ program sfall to convert map file to reflection list."
    },
    {
        "title": "**5**",
        "body": "Use _ccp4_ program sortmtz to sort reflection list."
    },
    {
        "title": "**6**",
        "body": "Use _ccp4_ program CAD to remove systematic absences and restore correct space group."
    },
    {
        "title": "**7**",
        "body": "Scale amplitudes to original values for each resolution shell, using Shellscale."
    },
    {
        "title": "**8**",
        "body": "Phase extension: Add an incremental amount of amplitude information and return to step 1."
    }
]